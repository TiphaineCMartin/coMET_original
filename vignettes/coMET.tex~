%\VignetteIndexEntry{coMET users guide}
%\VignetteDepends{coMET}
%\VignetteKeywords{Software, Visualization, GenomeAnnotation, GeneRegulation, GenomicVariation, DNAMethylation, SNP, GeneExpression }
%\VignettePackage{coMET}
\documentclass[11pt]{article}

% A bunch of styles and package requirements for the Bioconductor vignette branding
\RequirePackage{/home/tiphaine/R/x86_64-pc-linux-gnu-library/3.1/BiocStyle/sty/Bioconductor}

\AtBeginDocument{\bibliographystyle{/home/tiphaine/R/x86_64-pc-linux-gnu-library/3.1/BiocStyle/sty/unsrturl}}

\RequirePackage[utf8]{inputenc} 

% \RequirePackage{hyperref}
\RequirePackage{url}
\RequirePackage[authoryear,round]{natbib}
\bibliographystyle{plainnat}
% \RequirePackage[text={7.2in,9in},centering]{geometry}
%\RequirePackage{Sweave}
%\setkeys{Gin}{width=0.95\textwidth}
\RequirePackage{longtable}
\RequirePackage{graphicx}
\newcommand{\code}[1]{{\texttt{#1}}}
\newcommand{\term}[1]{{\emph{#1}}}
\newcommand{\Rmethod}[1]{{\textit{#1}}}
\newcommand{\Rfunarg}[1]{{\textit{#1}}}
\newcommand{\scscst}{\scriptscriptstyle}
\newcommand{\scst}{\scriptstyle}
\newcommand{\mgg}[0]{\Rpackage{coMET} }
\newcommand{\Reference}[1]{{\texttt{#1}}}
\newcommand{\link}[1]{{#1}}
\newcommand{\RR}[0]{{\texttt{R}}}

\title{The coMET User Guide}
\author{Tiphaine Martin \footnote{tiphain.martin@kcl.ac.uk}, Idil Erte \footnote{idil.erte@kcl.ac.uk}, Pei-Chien Tsai \footnote{peichien.tsai@kcl.ac.uk}, Jordana T. Bell \footnote{jordana.bell@kcl.ac.uk}}
\date{Edited: September 2014; Compiled: \today}

\usepackage{Sweave}
\begin{document}
\input{coMET-concordance}
%\SweaveOpts{concordance=TRUE}

\maketitle

\tableofcontents
\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
The CoMET package is a web-based plotting tool and R-based package to visualize EWAS (epigenome-wide association scan) results in a genomic region of interest. CoMET provides a plot of the EWAS association signal and visualisation of the methylation correlation between CpG sites (co-methylation). The CoMET package also provides the option to annotate the region using functional genomic information, including both user-defined features and pre-selected features based on the Encode project. The plot can be customized with different parameters, such as plot labels, colours, symbols, heatmap colour scheme, significance thresholds, and including reference CpG sites. Finally, the tool can also be applied to display the correlation patterns of other genomic data, e.g. gene expression array data.


\section{Usage}
CoMET requires the installation of R, the statistical computing software, freely available for Linux, Windows, or MacOS.CoMET can be downloaded from bioconductor. Packages can be installed using the install.packages command in R.  The coMET R package includes two major functions comet.web and comet. the function ’comet.web’ generates output plot with the same settings of genomic annotation tracks as that of the webservice (http://www.epigen.kcl.ac.uk/comet). the function ’comet’ generates output plots with the customized annotation tracks defined by user. 

\begin{Schunk}
\begin{Sinput}
> source("http://bioconductor.org/biocLite.R")
> biocLite("coMET")
\end{Sinput}
\end{Schunk}

CoMET can be loaded into R using this command:

\begin{Schunk}
\begin{Sinput}
> library(comet)
\end{Sinput}
\end{Schunk}

The configuration file ammends the options for the plot to be produced from comet. Example configuration and input files are also provided in the webervice(http://www.epigen.kcl.ac.uk/comet and http://comet.epigen.kcl.ac.uk:3838/coMET/). Information about the package can viewed from within R using this command.

\begin{Schunk}
\begin{Sinput}
> `?`(comet)
\end{Sinput}
\begin{Soutput}
No documentation for ‘comet’ in specified packages and libraries:
you could try ‘??comet’
\end{Soutput}
\begin{Sinput}
> `?`(comet.web)
\end{Sinput}
\begin{Soutput}
No documentation for ‘comet.web’ in specified packages and libraries:
you could try ‘??comet.web’
\end{Soutput}
\end{Schunk}


\section{File Formats}
4 formats (option CORMATRIX.FORMAT) describes tab-delimited correlation file 
(option CORMATRIX.FILE): 
\begin{enumerate}
  \item CORMATRIX: the data has already pre-computed by users; 
  \item RAW: The data is at raw format and can be computed by one of 3 methods 
Spearman, Pearson, Kendall (option CORMATRIX.METHOD). ; 
  \item 2 other formats are when the association data and correlation matrix are in the 
same file defined in the option DATA.FILE (region to visualize (option DATA.FILE) 
Others describing the P-value and optionally the direction of association (for example gene expression, validation studies) (option DATA.FILE.LARGE)) 
\end{enumerate}


\subsection{Format of info file(mandatory):}
Info file can be a list of CpG sites with/without Beta value (or direction sign). If it is a site file then it is mandatory to have the 4 columns as shown below with headers in the same order. Beta can be the 5th column(optional) and it can be either a numeric value (positive or negative values) or only direction sign ("+", "-")

\begin{Schunk}
\begin{Sinput}
> infofile <- "../data/cyp1b1info.txt"
> data_info <- read.csv(infofile, header = TRUE, sep = "\t", quote = "")
> head(data_info)
\end{Sinput}
\begin{Soutput}
    TargetID CHR  MAPINFO         Pval
1 cg22248750   2 38294160 2.749858e-01
2 cg11656478   2 38297759 7.794549e-01
3 cg14407177   2 38298023 2.863869e-01
4 cg02162897   2 38300537 3.148201e-07
5 cg20408276   2 38300586 1.467739e-06
6 cg00565882   2 38300707 7.563132e-03
\end{Soutput}
\end{Schunk}

Also it can be region with/without an end start of the base pair. If it is a region file then it is mandatory to have the 5 columns below with headers in this order. Beta can be the 6th column(optional).

\begin{Schunk}
\begin{Sinput}
> infoexp <- "../data/cyp1b1info_expr_reduce_region.txt"
> data_infoexp <- read.csv(infoexp, header = TRUE, sep = "\t", quote = "")
> head(data_infoexp)
\end{Sinput}
\begin{Soutput}
                             TargetID CHR MAPINFO.START MAPINFO.STOP         Pval BETA
1 ENSG00000138061.7_38294652_38298453   2      38294652     38298453 3.064357e-17    +
2 ENSG00000138061.7_38301489_38302532   2      38301489     38302532 1.145430e-07    +
3 ENSG00000138061.7_38302919_38303323   2      38302919     38303323 1.014050e-08    -
\end{Soutput}
\end{Schunk}

\subsection{Format of correlation matrix(mandatory):}
The data can be either pre-calculated correlation matrix or raw data. If it is a raw data then you can select the type of correlation method (spearman ,kendall or pearson).

\begin{Schunk}
\begin{Sinput}
> corfile <- "../data/cyp1b1res_37.txt"
> data_cor <- read.csv(corfile, header = TRUE, sep = "\t", quote = "")
> data_cor[1:6, 1:6]
\end{Sinput}
\begin{Soutput}
   cg22248750 cg11656478 cg14407177  cg02162897 cg20408276   cg00565882
1 -0.08636815 -0.4896557  1.6718967  0.52423342  0.1659252  0.224221521
2 -0.00107899 -0.6330666  0.3150612 -0.29820805 -0.4339332 -0.007794883
3  0.31656883 -0.2610083 -0.4942691  0.04657351  0.1840397  0.313967471
4 -0.40914999  0.6816058 -0.3251337 -0.58656175 -0.2069954  0.150719803
5  1.29953262  0.3985525  0.1119045  0.81181511  0.1833470  0.194928273
6 -1.11948826  0.3035820 -1.2794597 -0.49785237  0.1076348 -0.876011670
\end{Soutput}
\end{Schunk}


\subsection{Format of extra info file:}

This can be another type of info file (e.g Expression data or replication data) and it follows the same rules than the info file.

\subsection{Format of annotation file}

format accepted by GViz such as BED, GTF, and GFF3 format

\subsection{Option of config.file}

If you would like to make your own changes to the plot you can download the configuration file from this site. After you make the relative changes you can upload it to the server again and plot.

\begin{Schunk}
\begin{Sinput}
> configfile <- "../data/config_cyp1b1_zoom_4webserver.txt"
> data_config <- read.csv(configfile, quote = "")
> data_config
\end{Sinput}
\begin{Soutput}
                                MYDATA.FILE.cyp1b1info.txt
1                                         DISP.MYDATA=TRUE
2                                       MYDATA.FORMAT=SITE
3                                    MYDATA.REF=cg02162897
4                              PVAL.THRESHOLD=4.720623e-06
5                                   DISP.ASSOCIATION=FALSE
6                                        DISP.REGION=FALSE
7      MYDATA.LARGE.FILE=cyp1b1info_expr_reduce_region.txt
8                          MYDATA.LARGE.FORMAT=REGION_ASSO
9                              DISP.ASSOCIATION.LARGE=TRUE
10                                  DISP.REGION.LARGE=TRUE
11                    SAMPLE.LABELS.LARGE=Gene expression 
12                                  COLOR.LIST.LARGE=green
13                              SYMBOLS.LARGE=diamond-fill
14                                          START=38290160
15                                            END=38303219
16                                      SAMPLE.LABELS=CpG 
17                                     SYMBOLS=circle-fill
18                                               LAB.Y=log
19                                     DISP.COLOR.REF=TRUE
20                         CORMATRIX.FILE=cyp1b1res_37.txt
21                                    CORMATRIX.FORMAT=RAW
22                                  DISP.CORMATRIXMAP=TRUE
23                               CORMATRIX.METHOD=spearman
24                     CORMATRIX.COLOR.SCHEME=bluewhitered
25                                     DISP.PHYS.DIST=TRUE
26                                     DISP.COLOR.BAR=TRUE
27                                        DISP.TYPE=symbol
28                                        DISP.LEGEND=TRUE
29                           LIST.TRACKS=transcriptENSEMBL
30                                                     CGI
31                                                ChromHMM
32                                                   DNAse
33                                              RegENSEMBL
34                                                     SNP
35                                   DISP.MULT.LAB.X=FALSE
36                                          IMAGE.TYPE=pdf
37 IMAGE.TITLE="Example a-DMR in CYP1B1 in Adipose tissue"
38                   IMAGE.NAME=cyp1b1_zoom_plus_name_expr
39                                          IMAGE.SIZE=3.5
40                                             GENOME=hg19
41                      DATASET.GENE=hsapiens_gene_ensembl
42                                DATASET.SNP=hsapiens_snp
43                                    VERSION.DBSNP=snp138
44                      DATASET.SNP.STOMA=hsapiens_snp_som
45                 DATASET.REGULATION=hsapiens_feature_set
46                         DATASET.STRU=hsapiens_structvar
47               DATASET.STRU.STOMA=hsapiens_structvar_som
48                              PATTERN.REGULATION=GM12878
49                                    BROWSER.SESSION=UCSC
\end{Soutput}
\end{Schunk}

\section{Creation plot like webservice:}
It is possible to use simply the creation of plot with the function comet.web

 \begin{figure}
\begin{Schunk}
\begin{Soutput}
START COMET  VERSION WEB
START READ.CONFIG
FINISH READ.CONFIG
START CREATE.COLOR.LIST
FINISH CREATE.COLOR.LIST
START CREATE.SYMBOL.LIST
FINISH CREATE.SYMBOL.LIST
START CREATE.COLOR.LIST.LARGE
FINISH CREATE.COLOR.LIST.LARGE
START CREATE.SYMBOL.LIST.LARGE
FINISH CREATE.SYMBOL.LIST.LARGE
START RETRIEVE.DATA.MYDATA
START READ.FILE.MYDATA  1 
START CHECK.FORMAT.MYDATA
mydata.test  37 4 
mydata.test  MYDATA.NAME CHROMOSOME LOC MYDATA.PVAL 
mydata.format  SITE 
Missing column CHROMOSOME should be at UCSC format
FINISH CHECK.FORMAT.MYDATA
FINISH READ.FILE.MYDATA  1 
READ  1  MYDATA file 
format SITESTART SET.IMAGE.PARAMETERS
FINISH SET.IMAGE.PARAMETERS
START FIX.VALUES
FINISH FIX.VALUES
Ref 38300537 
START READ.FILE.COMATRIX
START COMPUTE.CORMATRIX
FINISH COMPUTE.CORMATRIX
Ref position 4 
FINISH READ.FILE.COMET
START READ.FILE.MYDATA.LARGE  1  
Missing column CHROMOSOME should be at UCSC format
START CHECK.FORMAT.MYDATA.LARGE
mydata.test  3 6 
mydata.test  MYDATA.NAME CHROMOSOME LOC.START LOC.END MYDATA.PVAL MYDATA.ASSO 
mydata.format  REGION_ASSO 
Missing column CHROMOSOME should be at UCSC format
FINISH CHECK.FORMAT.MYDATA
FINISH READ.FILE.MYDATA.LARGE 
START FIX.VALUES.GENERIC
FINISH FIX.VALUES.GENERIC
FINISH RETRIEVE.DATA
START CREATE.TRACKS.WEB
FINISH CREATE.TRACKS.WEB
START DRAW.PLOT
START DRAW.PLOT.GRID.SETUP
START DRAW.PLOT.LINESCONNECTION
BUGgg HERE 
FINISH DRAW.PLOT.LINECONNECTION
START DRAW.PLOT.AXIS.DATA
FINISH DRAW.PLOT.AXIS.DATA
FINISH DRAW.PLOT.GRID.SETUP
START READ.FILE.MYDATA.LARGE  1  
Missing column CHROMOSOME should be at UCSC format
START CHECK.FORMAT.MYDATA.LARGE
mydata.test  3 6 
mydata.test  MYDATA.NAME CHROMOSOME LOC.START LOC.END MYDATA.PVAL MYDATA.ASSO 
mydata.format  REGION_ASSO 
Missing column CHROMOSOME should be at UCSC format
FINISH CHECK.FORMAT.MYDATA
FINISH READ.FILE.MYDATA.LARGE 
START FIX.VALUES
FINISH FIX.VALUES
START DRAW.PLOT.GRID.MYDATA.LARGE
format  REGION_ASSO 
Sample 1 
format  REGION_ASSO 
Region TRUE 
position.start  38294652 
position.end  38298453 
y 16.51366 
axis.x  38290160 38291160 38292160 38293160 38294160 38295160 38296160 38297160 38298160 38299160 38300160 38301160 38302160 38303219 
format  REGION_ASSO 
Sample 1 
format  REGION_ASSO 
Region TRUE 
position.start  38301489 
position.end  38302532 
y 6.941032 
axis.x  38290160 38291160 38292160 38293160 38294160 38295160 38296160 38297160 38298160 38299160 38300160 38301160 38302160 38303219 
format  REGION_ASSO 
Sample 1 
format  REGION_ASSO 
Region TRUE 
position.start  38302919 
position.end  38303220 
y 7.993941 
axis.x  38290160 38291160 38292160 38293160 38294160 38295160 38296160 38297160 38298160 38299160 38300160 38301160 38302160 38303219 
FINISH DRAW.PLOT.GRID.MYDATA.LARGE
START READ.FILE.MYDATA  1 
START CHECK.FORMAT.MYDATA
mydata.test  37 4 
mydata.test  MYDATA.NAME CHROMOSOME LOC MYDATA.PVAL 
mydata.format  SITE 
Missing column CHROMOSOME should be at UCSC format
FINISH CHECK.FORMAT.MYDATA
FINISH READ.FILE.MYDATA  1 
START FIX.VALUES
FINISH FIX.VALUES
START DRAW.PLOT.GRID.MYDATA
START CREATE COLOR BAR
FINISH CREATE.COLOR.BAR
FINISH DRAW.PLOT.GRID.MYDATA
START DRAW.LEGEND
FINISH DRAW.LEGEND
START DRAW.PLOT.CORMATRIX.PLOT
START CREATE COLOR BAR
FINISH CREATE.COLOR.BAR
FINISH DRAW.PLOT.CORMATRIX.PLOT
START DRAW.PLOT.ANNOTATION
FINISH DRAW.PLOT.ANNOTATION
START DRAW.NAME.GENES.WEB
Gene 1 : RMDN2-AS1 
Gene 2 : CYP1B1-AS1 
Gene 3 : RMDN2 
Gene 4 : CYP1B1 
FINISH DRAW.NAME.GENES.WEB
START CREATE.NAME.TRACKS.WEB
FINISH DRAW.NAME.TRACKS.WEB
FINISH DRAW.PLOT
FINISH WEB COMET 
\end{Soutput}
\end{Schunk}
\includegraphics{coMET-cometwebPlot}
\caption{Plot with comet.web function.\label{fig:cometweb_simple}}
  \end{figure}

\clearpage
\section*{SessionInfo}
The following is the session info that generated this vignette:
\begin{Schunk}
\begin{Sinput}
> sessionInfo()
\end{Sinput}
\begin{Soutput}
R version 3.1.1 (2014-07-10)
Platform: x86_64-pc-linux-gnu (64-bit)

locale:
 [1] LC_CTYPE=en_GB.UTF-8       LC_NUMERIC=C               LC_TIME=en_US.UTF-8       
 [4] LC_COLLATE=en_GB.UTF-8     LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_GB.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                  LC_ADDRESS=C              
[10] LC_TELEPHONE=C             LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] parallel  grid      stats     graphics  grDevices utils     datasets  methods  
[9] base     

other attached packages:
 [1] XVector_0.4.0        colortools_0.1.5     rtracklayer_1.24.2   GenomicRanges_1.16.4
 [5] GenomeInfoDb_1.0.2   IRanges_1.22.10      ggbio_1.12.10        ggplot2_1.0.0       
 [9] Gviz_1.8.4           BiocGenerics_0.10.0  biomaRt_2.20.0       hash_2.2.6          
[13] knitr_1.6           

loaded via a namespace (and not attached):
 [1] acepack_1.3-3.3          AnnotationDbi_1.26.0     base64enc_0.1-2         
 [4] BatchJobs_1.3            BBmisc_1.7               Biobase_2.24.0          
 [7] BiocParallel_0.6.1       BiocStyle_1.2.0          Biostrings_2.32.1       
[10] biovizBase_1.12.3        bitops_1.0-6             brew_1.0-6              
[13] BSgenome_1.32.0          checkmate_1.4            cluster_1.15.3          
[16] codetools_0.2-9          colorspace_1.2-4         DBI_0.3.0               
[19] dichromat_2.0-0          digest_0.6.4             evaluate_0.5.5          
[22] fail_1.2                 foreach_1.4.2            foreign_0.8-61          
[25] formatR_1.0              Formula_1.1-2            GenomicAlignments_1.0.6 
[28] GenomicFeatures_1.16.2   gridExtra_0.9.1          gtable_0.1.2            
[31] Hmisc_3.14-5             iterators_1.0.7          lattice_0.20-29         
[34] latticeExtra_0.6-26      MASS_7.3-34              matrixStats_0.10.0      
[37] munsell_0.4.2            nnet_7.3-8               plyr_1.8.1              
[40] proto_0.3-10             RColorBrewer_1.0-5       Rcpp_0.11.2             
[43] RCurl_1.95-4.3           reshape2_1.4             R.methodsS3_1.6.1       
[46] rpart_4.1-8              Rsamtools_1.16.1         RSQLite_0.11.4          
[49] scales_0.2.4             sendmailR_1.2-1          splines_3.1.1           
[52] stats4_3.1.1             stringr_0.6.2            survival_2.37-7         
[55] tools_3.1.1              VariantAnnotation_1.10.5 XML_3.98-1.1            
[58] zlibbioc_1.10.0         
\end{Soutput}
\end{Schunk}
\end{document}
